---
title: WebSocket æ’ä»¶ (websocket-plugin)
sidebar:
  order: 7
---

`websocket-plugin` ä¸º MQTT Broker æä¾› WebSocket åè®®æ”¯æŒï¼Œå…è®¸å®¢æˆ·ç«¯é€šè¿‡ WebSocket è¿æ¥è¿›è¡Œ MQTT é€šä¿¡ã€‚

## æ¦‚è¿°

åœ¨ç°ä»£ Web åº”ç”¨ä¸­ï¼Œæµè§ˆå™¨ç«¯çš„ MQTT å®¢æˆ·ç«¯æ— æ³•ç›´æ¥ä½¿ç”¨ TCP è¿æ¥ã€‚WebSocket åè®®æä¾›äº†ä¸€ç§åœ¨æµè§ˆå™¨ä¸­ä¸ MQTT Broker é€šä¿¡çš„æ ‡å‡†æ–¹å¼ã€‚

### é€‚ç”¨åœºæ™¯

- **Web åº”ç”¨**: åœ¨æµè§ˆå™¨ä¸­å®ç°å®æ—¶æ•°æ®å±•ç¤º
- **å°ç¨‹åº**: å¾®ä¿¡å°ç¨‹åºç­‰å¹³å°çš„ MQTT è¿æ¥
- **ç§»åŠ¨ç«¯ H5**: ç§»åŠ¨ Web åº”ç”¨çš„æ¶ˆæ¯æ¨é€
- **å®æ—¶ç›‘æ§å¤§å±**: æ•°æ®å¯è§†åŒ–å®æ—¶æ›´æ–°

### æ ¸å¿ƒç‰¹æ€§

- åŸºäº Feat æ¡†æ¶çš„ HTTP æœåŠ¡å™¨å®ç° WebSocket å‡çº§
- æ”¯æŒ MQTT over WebSocket åè®®ï¼ˆSec-WebSocket-Protocol: mqttï¼‰
- ä½¿ç”¨ ByteBuffer å¤„ç†äºŒè¿›åˆ¶æ¶ˆæ¯æµ
- ä¸æ ¸å¿ƒ Broker å…±äº«ç›¸åŒçš„æ¶ˆæ¯å¤„ç†å™¨å’Œä¼šè¯ç®¡ç†

## æ¶æ„åŸç†

### WebSocket å‡çº§æµç¨‹

```mermaid
sequenceDiagram
    participant Browser as Web Browser
    participant Feat as Feat HTTP Server
    participant Upgrade as WebSocketUpgrade
    participant Proxy as ProxySession
    participant Broker as MQTT Broker
    
    Note over Browser,Broker: WebSocket æ¡æ‰‹é˜¶æ®µ
    
    Browser->>Feat: HTTP GET /mqtt
    Note right of Browser: Headers:<br/>Upgrade: websocket<br/>Sec-WebSocket-Protocol: mqtt
    
    Feat->>Feat: æ£€æŸ¥ Upgrade å¤´
    Feat->>Upgrade: åˆ›å»º WebSocketUpgrade
    
    Upgrade-->>Browser: 101 Switching Protocols
    Note left of Upgrade: Headers:<br/>Sec-WebSocket-Protocol: mqtt<br/>Connection: Upgrade
    
    Note over Browser,Broker: MQTT é€šä¿¡é˜¶æ®µ
    
    Upgrade->>Proxy: åˆ›å»º ProxySession
    Proxy->>Broker: stateEvent(NEW_SESSION)
    
    Browser->>Upgrade: WebSocket Binary Frame
    Upgrade->>Upgrade: decode(MqttProtocol)
    Upgrade->>Broker: process(MqttMessage)
    
    Broker->>Upgrade: å“åº”æ¶ˆæ¯
    Upgrade->>Browser: WebSocket Binary Frame
```

### æ¶æ„è®¾è®¡

```mermaid
flowchart TD
    subgraph Browser["æµè§ˆå™¨/Web å®¢æˆ·ç«¯"]
        WSClient["WebSocket Client<br/>MQTT.js / Paho"]
    end
    
    subgraph WebSocketPlugin["websocket-plugin"]
        HttpServer["Feat HttpServer"]
        HttpHandler["HttpHandler"]
        
        subgraph WebSocketHandler["WebSocket Handler"]
            OnHandshake["onHandShake()"]
            OnBinary["handleBinaryMessage()"]
            OnDestroy["destroy()"]
        end
        
        ProxySession["ProxySession"]
        ProxyBuffer["ProxyWriteBuffer"]
        ReadBuffer["ByteBuffer"]
    end
    
    subgraph CoreBroker["Core Broker"]
        MqttProcessor["MqttMessageProcessor"]
        SessionManager["Session Manager"]
        MessageRouter["Message Router"]
    end
    
    WSClient <-->|WebSocket<br/>Port: 8083| HttpServer
    HttpServer --> HttpHandler
    HttpHandler --> OnHandshake
    HttpHandler --> OnBinary
    HttpHandler --> OnDestroy
    
    OnHandshake --> ProxySession
    ProxySession --> SessionManager
    
    OnBinary --> ReadBuffer
    ReadBuffer -->|decode| MqttProcessor
    MqttProcessor --> MessageRouter
    
    OnDestroy -->|SESSION_CLOSED| SessionManager
```

### æ•°æ®æµè½¬

```mermaid
sequenceDiagram
    participant Browser as Browser Client
    participant WebSocket as WebSocket Connection
    participant Proxy as ProxySession
    participant Protocol as MqttProtocol
    participant Processor as MQTT Processor
    
    Note over Browser,Processor: æ¶ˆæ¯æ¥æ”¶æµç¨‹
    
    Browser->>WebSocket: å‘é€äºŒè¿›åˆ¶æ•°æ®
    WebSocket->>WebSocket: handleBinaryMessage(data)
    WebSocket->>WebSocket: readBuffer.put(data)
    
    loop è§£ç æ‰€æœ‰å®Œæ•´æ¶ˆæ¯
        WebSocket->>Protocol: protocol.decode(readBuffer)
        Protocol-->>WebSocket: MqttMessage
        WebSocket->>Processor: processor.process(proxySession, message)
        Processor->>Processor: å¤„ç† MQTT é€»è¾‘
        Processor->>Proxy: proxySession.writeBuffer().flush()
    end
    
    Note over Browser,Processor: æ¶ˆæ¯å‘é€æµç¨‹
    
    Processor->>Proxy: å†™å…¥å“åº”
    Proxy->>WebSocket: é€šè¿‡ WebSocket å‘é€
    WebSocket->>Browser: WebSocket Binary Frame
```

## æ ¸å¿ƒç»„ä»¶

| ç»„ä»¶ | ç±»å | èŒè´£ |
|------|------|------|
| æ’ä»¶å…¥å£ | [`WebSocketPlugin`](https://gitee.com/smartboot/smart-mqtt/blob/master/plugins/websocket-plugin/src/main/java/tech/smartboot/mqtt/ws/WebSocketPlugin.java) | åˆå§‹åŒ– WebSocket æœåŠ¡å™¨ |
| é…ç½®ç®¡ç† | [`PluginConfig`](https://gitee.com/smartboot/smart-mqtt/blob/master/plugins/websocket-plugin/src/main/java/tech/smartboot/mqtt/ws/PluginConfig.java) | ç®¡ç†ç›‘å¬ç«¯å£é…ç½® |
| ä¼šè¯ä»£ç† | [`ProxySession`](https://gitee.com/smartboot/smart-mqtt/blob/master/plugins/websocket-plugin/src/main/java/tech/smartboot/mqtt/ws/ProxySession.java) | é€‚é… WebSocket åˆ° MQTT ä¼šè¯æ¥å£ |
| å†™å…¥ç¼“å†² | [`ProxyWriteBuffer`](https://gitee.com/smartboot/smart-mqtt/blob/master/plugins/websocket-plugin/src/main/java/tech/smartboot/mqtt/ws/ProxyWriteBuffer.java) | å¤„ç† WebSocket æ•°æ®å†™å…¥ |

## é…ç½®å‚æ•°

åœ¨ `plugin.yaml` ä¸­é…ç½®ï¼š

```yaml
# WebSocket ç›‘å¬ç«¯å£
port: 8083
```

### å‚æ•°è¯¦è§£

| å‚æ•°å | ç±»å‹ | é»˜è®¤å€¼ | å¿…å¡« | è¯´æ˜ |
|--------|------|--------|------|------|
| `port` | int | 8083 | æ˜¯ | WebSocket æœåŠ¡ç›‘å¬ç«¯å£ |

## éƒ¨ç½²ç¤ºä¾‹

### åŸºç¡€é…ç½®

```yaml
# plugin.yaml
port: 8083
```

### å¤šåè®®å…±å­˜é…ç½®

```yaml
# broker.yaml - MQTT TCP ç«¯å£
port: 1883
host: 0.0.0.0
```

```yaml
# plugins/websocket-plugin/plugin.yaml
port: 8083
```

### Docker Compose éƒ¨ç½²

```yaml
version: '3.8'

services:
  mqtt-broker:
    image: smartboot/smart-mqtt:latest
    ports:
      - "1883:1883"    # MQTT TCP
      - "8083:8083"    # WebSocket
    volumes:
      - ./broker.yaml:/app/conf/broker.yaml
      - ./plugin.yaml:/app/plugins/websocket-plugin/plugin.yaml
```

## å®¢æˆ·ç«¯è¿æ¥

### MQTT.js (æµè§ˆå™¨)

```html
<!DOCTYPE html>
<html>
<head>
    <script src="https://unpkg.com/mqtt/dist/mqtt.esm.js"></script>
</head>
<body>
    <script type="module">
        import mqtt from 'https://unpkg.com/mqtt/dist/mqtt.esm.js';
        
        // è¿æ¥ WebSocket MQTT
        const client = mqtt.connect('ws://localhost:8083/mqtt', {
            clientId: 'web_client_' + Math.random().toString(16).substr(2, 8),
            clean: true,
            connectTimeout: 4000,
            reconnectPeriod: 1000
        });
        
        client.on('connect', () => {
            console.log('WebSocket è¿æ¥æˆåŠŸ');
            
            // è®¢é˜…ä¸»é¢˜
            client.subscribe('sensor/+/temperature', (err) => {
                if (!err) {
                    console.log('è®¢é˜…æˆåŠŸ');
                }
            });
        });
        
        client.on('message', (topic, message) => {
            console.log(`æ”¶åˆ°æ¶ˆæ¯ [${topic}]: ${message.toString()}`);
            // æ›´æ–°é¡µé¢æ˜¾ç¤º
            document.getElementById('data').innerHTML += 
                `<p>${topic}: ${message}</p>`;
        });
        
        // å‘å¸ƒæ¶ˆæ¯
        function publish() {
            client.publish('test/topic', 'Hello from WebSocket');
        }
    </script>
    <div id="data"></div>
    <button onclick="publish()">å‘é€æ¶ˆæ¯</button>
</body>
</html>
```

### å¾®ä¿¡å°ç¨‹åº

```javascript
// app.js æˆ–é¡µé¢é€»è¾‘
const mqtt = require('mqtt.min.js');

Page({
    data: {
        client: null
    },
    
    onLoad() {
        this.connectMqtt();
    },
    
    connectMqtt() {
        const client = mqtt.connect('wx://broker.example.com:8083/mqtt', {
            clientId: 'weapp_' + new Date().getTime(),
            username: 'admin',
            password: 'admin123'
        });
        
        client.on('connect', () => {
            console.log('MQTT è¿æ¥æˆåŠŸ');
            wx.showToast({ title: 'è¿æ¥æˆåŠŸ' });
            
            // è®¢é˜…è®¾å¤‡çŠ¶æ€
            client.subscribe('device/+/status');
        });
        
        client.on('message', (topic, message) => {
            console.log('æ”¶åˆ°æ¶ˆæ¯:', topic, message.toString());
            this.setData({
                lastMessage: message.toString()
            });
        });
        
        this.setData({ client });
    },
    
    publishMessage() {
        const { client } = this.data;
        if (client && client.connected) {
            client.publish('control/device1', JSON.stringify({
                action: 'turn_on'
            }));
        }
    }
});
```

### Vue.js é›†æˆ

```vue
<template>
  <div class="mqtt-dashboard">
    <h2>å®æ—¶æ•°æ®ç›‘æ§</h2>
    <div class="connection-status">
      çŠ¶æ€: {{ connected ? 'å·²è¿æ¥' : 'æœªè¿æ¥' }}
    </div>
    <div class="messages">
      <div v-for="(msg, index) in messages" :key="index" class="message">
        <span class="topic">{{ msg.topic }}</span>
        <span class="payload">{{ msg.payload }}</span>
        <span class="time">{{ msg.time }}</span>
      </div>
    </div>
  </div>
</template>

<script>
import mqtt from 'mqtt';

export default {
  data() {
    return {
      client: null,
      connected: false,
      messages: []
    };
  },
  
  mounted() {
    this.connect();
  },
  
  beforeDestroy() {
    if (this.client) {
      this.client.end();
    }
  },
  
  methods: {
    connect() {
      this.client = mqtt.connect('ws://localhost:8083/mqtt', {
        clientId: 'vue_client_' + Math.random().toString(16).substr(2, 8)
      });
      
      this.client.on('connect', () => {
        this.connected = true;
        this.client.subscribe('sensors/#');
      });
      
      this.client.on('message', (topic, message) => {
        this.messages.unshift({
          topic,
          payload: message.toString(),
          time: new Date().toLocaleTimeString()
        });
        // åªä¿ç•™æœ€è¿‘ 100 æ¡
        if (this.messages.length > 100) {
          this.messages.pop();
        }
      });
    }
  }
};
</script>
```

### React é›†æˆ

```jsx
import React, { useEffect, useState } from 'react';
import mqtt from 'mqtt';

function MqttDashboard() {
  const [client, setClient] = useState(null);
  const [connected, setConnected] = useState(false);
  const [messages, setMessages] = useState([]);
  
  useEffect(() => {
    const mqttClient = mqtt.connect('ws://localhost:8083/mqtt', {
      clientId: 'react_client_' + Math.random().toString(16).substr(2, 8)
    });
    
    mqttClient.on('connect', () => {
      setConnected(true);
      mqttClient.subscribe('iot/+/data');
    });
    
    mqttClient.on('message', (topic, message) => {
      setMessages(prev => [...prev, {
        topic,
        payload: message.toString(),
        timestamp: Date.now()
      }].slice(-50));
    });
    
    setClient(mqttClient);
    
    return () => {
      mqttClient.end();
    };
  }, []);
  
  return (
    <div>
      <h2>MQTT å®æ—¶ç›‘æ§</h2>
      <p>è¿æ¥çŠ¶æ€: {connected ? 'ğŸŸ¢' : 'ğŸ”´'}</p>
      <ul>
        {messages.map((msg, idx) => (
          <li key={idx}>
            <strong>{msg.topic}</strong>: {msg.payload}
          </li>
        ))}
      </ul>
    </div>
  );
}

export default MqttDashboard;
```

## æ³¨æ„äº‹é¡¹

:::caution[é‡è¦æç¤º]
- **è·¯å¾„é…ç½®**: WebSocket è·¯å¾„é»˜è®¤ä¸º `/mqtt`ï¼Œå®¢æˆ·ç«¯è¿æ¥æ—¶éœ€æ­£ç¡®é…ç½®
- **åè®®å¤´**: æ’ä»¶å“åº” `Sec-WebSocket-Protocol: mqtt`ï¼Œç¡®ä¿å®¢æˆ·ç«¯æ­£ç¡®è®¾ç½®
- **æµè§ˆå™¨å…¼å®¹**: ç°ä»£æµè§ˆå™¨å‡æ”¯æŒ WebSocketï¼ŒIE éœ€ä½¿ç”¨ polyfill
- **è¿æ¥æ•°é™åˆ¶**: æµè§ˆå™¨å¯¹åŒä¸€åŸŸåçš„ WebSocket è¿æ¥æ•°æœ‰é™åˆ¶ï¼ˆé€šå¸¸ 6-30 ä¸ªï¼‰
- **å¿ƒè·³ä¿æŒ**: å»ºè®®å®¢æˆ·ç«¯å¯ç”¨ keepalive ä¿æŒè¿æ¥æ´»è·ƒ
:::

## æ€§èƒ½ä¼˜åŒ–

| ä¼˜åŒ–é¡¹ | å»ºè®® |
|--------|------|
| ç¼“å†²åŒºå¤§å° | æ ¹æ®æ¶ˆæ¯å¤§å°è°ƒæ•´ `readBufferSize` |
| è¿æ¥å¤ç”¨ | å•ä¸ªé¡µé¢å°½é‡å¤ç”¨ä¸€ä¸ª MQTT è¿æ¥ |
| æ¶ˆæ¯å‹ç¼© | å¤§æ•°æ®é‡åœºæ™¯å¯è€ƒè™‘å¯ç”¨ permessage-deflate |
| CDN éƒ¨ç½² | Web é™æ€èµ„æºä½¿ç”¨ CDN åŠ é€Ÿ |

## æ•…éšœæ’æŸ¥

| ç°è±¡ | å¯èƒ½åŸå›  | è§£å†³æ–¹æ¡ˆ |
|------|---------|---------|
| WebSocket è¿æ¥å¤±è´¥ | ç«¯å£æœªå¼€æ”¾ | æ£€æŸ¥é˜²ç«å¢™å’Œç«¯å£é…ç½® |
| åè®®æ¡æ‰‹å¤±è´¥ | Sec-WebSocket-Protocol ä¸åŒ¹é… | ç¡®ä¿å®¢æˆ·ç«¯æŒ‡å®š `mqtt` åè®® |
| æ¶ˆæ¯æ— æ³•æ¥æ”¶ | è®¢é˜…ä¸»é¢˜ä¸åŒ¹é… | æ£€æŸ¥ä¸»é¢˜è¿‡æ»¤å™¨æ˜¯å¦æ­£ç¡® |
| è¿æ¥é¢‘ç¹æ–­å¼€ | å¿ƒè·³è¶…æ—¶ | è°ƒæ•´å®¢æˆ·ç«¯ keepalive é—´éš” |

## å®‰å…¨å»ºè®®

```javascript
// ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ WSS (WebSocket Secure)
const client = mqtt.connect('wss://broker.example.com:8084/mqtt', {
    rejectUnauthorized: true,  // éªŒè¯æœåŠ¡å™¨è¯ä¹¦
    ca: CA_CERTIFICATE,         // æŒ‡å®š CA è¯ä¹¦
    username: 'user',
    password: 'pass'
});
```

å»ºè®®é…åˆ `mqtts-plugin` æä¾›çš„è¯ä¹¦ï¼Œå®ç°å…¨é“¾è·¯åŠ å¯†ã€‚

## æŠ€æœ¯æ”¯æŒ

- **ä½œè€…**: ä¸‰åˆ€ï¼ˆzhengjunweimail@163.comï¼‰
- **ä¾›åº”å•†**: smart-mqtt
- **ç‰ˆæœ¬**: ä¸ MQTT Broker ç‰ˆæœ¬ä¿æŒä¸€è‡´
