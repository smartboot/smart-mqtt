---
title: ç®€å•è®¤è¯æ’ä»¶ (simple-auth-plugin)
sidebar:
  order: 6
---

`simple-auth-plugin` æ˜¯ä¸€ä¸ªè½»é‡çº§çš„ MQTT è®¤è¯æ’ä»¶ï¼Œæä¾›åŸºäºç”¨æˆ·åå’Œå¯†ç çš„åŸºç¡€è®¤è¯åŠŸèƒ½ã€‚

## æ¦‚è¿°

åœ¨å¼€æ”¾çš„ MQTT ç¯å¢ƒä¸­ï¼Œä»»ä½•äººéƒ½å¯ä»¥è¿æ¥åˆ° broker å¹¶å‘å¸ƒ/è®¢é˜…æ¶ˆæ¯ï¼Œè¿™ä¼šå¸¦æ¥å®‰å…¨éšæ‚£ã€‚simple-auth-plugin æä¾›äº†æœ€åŸºç¡€çš„è®¤è¯æœºåˆ¶ï¼Œç¡®ä¿åªæœ‰åˆæ³•ç”¨æˆ·æ‰èƒ½æ¥å…¥ã€‚

### é€‚ç”¨åœºæ™¯

- **å¼€å‘æµ‹è¯•ç¯å¢ƒ**: å¿«é€Ÿæ­å»ºå¸¦è®¤è¯çš„æµ‹è¯•ç¯å¢ƒ
- **å°è§„æ¨¡éƒ¨ç½²**: ç”¨æˆ·æ•°é‡è¾ƒå°‘çš„åœºæ™¯
- **åŸºç¡€å®‰å…¨éœ€æ±‚**: ç®€å•çš„ç”¨æˆ·å/å¯†ç ä¿æŠ¤
- **æ¼”ç¤ºç¯å¢ƒ**: å±•ç¤ºè®¤è¯æµç¨‹çš„ç¤ºä¾‹

### æ ¸å¿ƒç‰¹æ€§

- æ”¯æŒå¤šç”¨æˆ·é…ç½®
- ç®€å•çš„ç”¨æˆ·å/å¯†ç è®¤è¯æœºåˆ¶
- åŸºäºäº‹ä»¶æ€»çº¿çš„éä¾µå…¥å¼å®ç°
- é…ç½®ç®€å•ï¼Œå³é…å³ç”¨

## æ¶æ„åŸç†

### è®¤è¯æµç¨‹

```mermaid
sequenceDiagram
    participant Client as MQTT Client
    participant Broker as MQTT Broker
    participant EventBus as EventBus
    participant Plugin as SimpleAuthPlugin
    participant Config as PluginConfig
    
    Note over Client,Config: MQTT è¿æ¥è®¤è¯æµç¨‹
    
    Client->>Broker: CONNECT (username, password)
    Broker->>EventBus: å‘å¸ƒ CONNECT äº‹ä»¶
    EventBus->>Plugin: è§¦å‘è®¤è¯æ¶ˆè´¹è€…
    
    Plugin->>Plugin: æ£€æŸ¥è®¤è¯æ˜¯å¦å·²å¤±è´¥
    
    alt å·²è®¤è¯å¤±è´¥
        Plugin-->>Broker: è·³è¿‡å¤„ç†
    else æœªè®¤è¯
        Plugin->>Config: æŸ¥è¯¢ç”¨æˆ·åˆ—è¡¨
        Config-->>Plugin: è¿”å›è´¦æˆ·ä¿¡æ¯
        
        alt ç”¨æˆ·åå¯†ç åŒ¹é…
            Plugin->>Broker: è®¾ç½® session.authorized = true
            Broker-->>Client: CONNACK (è¿”å›ç : 0)
        else è®¤è¯å¤±è´¥
            Plugin->>Broker: å‘é€ CONNACK (è¿”å›ç : 5 - æœªæˆæƒ)
            Broker->>Broker: æ ‡è®° session.disconnect = true
            Broker-->>Client: æ–­å¼€è¿æ¥
        end
    end
```

### äº‹ä»¶é©±åŠ¨æ¶æ„

```mermaid
flowchart TD
    subgraph Client["MQTT Client"]
        Connect["CONNECT æŠ¥æ–‡<br/>æºå¸¦ç”¨æˆ·åå¯†ç "]
    end
    
    subgraph Broker["MQTT Broker"]
        Processor["æ¶ˆæ¯å¤„ç†å™¨"]
        
        subgraph EventBus["äº‹ä»¶æ€»çº¿"]
            Event["CONNECT Event"]
        end
        
        subgraph Session["ä¼šè¯ç®¡ç†"]
            Auth["authorized æ ‡å¿—"]
            Disconnect["disconnect æ ‡å¿—"]
        end
    end
    
    subgraph Plugin["simple-auth-plugin"]
        Consumer["EventBusConsumer"]
        Checker["è®¤è¯æ£€æŸ¥å™¨"]
        AccountDB["è´¦æˆ·æ•°æ®åº“<br/>Map<username, password>"]
    end
    
    Connect --> Processor
    Processor --> Event
    Event --> Consumer
    Consumer --> Checker
    Checker --> AccountDB
    
    Checker -->|è®¤è¯æˆåŠŸ| Auth
    Checker -->|è®¤è¯å¤±è´¥| Disconnect
```

### æ’ä»¶ç”Ÿå‘½å‘¨æœŸ

```mermaid
sequenceDiagram
    participant Broker as BrokerContext
    participant Plugin as SimpleAuthPlugin
    participant Config as PluginConfig
    participant EventBus as EventBus
    
    Note over Broker,EventBus: æ’ä»¶å®‰è£…é˜¶æ®µ
    
    Broker->>Plugin: install(context)
    Plugin->>Config: loadPluginConfig()
    Config-->>Plugin: è¿”å›è´¦æˆ·åˆ—è¡¨
    Plugin->>Plugin: æ„å»º Map<username, password>
    Plugin->>Plugin: enabled = true
    
    Plugin->>EventBus: subscribe(CONNECT, Consumer)
    EventBus-->>Plugin: è®¢é˜…æˆåŠŸ
    
    Plugin-->>Broker: å®‰è£…å®Œæˆ
    
    Note over Broker,EventBus: æ’ä»¶å¸è½½é˜¶æ®µ
    
    Broker->>Plugin: uninstall()
    Plugin->>Plugin: enabled = false
    Plugin->>EventBus: å–æ¶ˆè®¢é˜…ï¼ˆé€šè¿‡ enable() è¿”å› falseï¼‰
    Plugin-->>Broker: å¸è½½å®Œæˆ
```

## æ ¸å¿ƒç»„ä»¶

| ç»„ä»¶ | ç±»å | èŒè´£ |
|------|------|------|
| æ’ä»¶å…¥å£ | [`SimpleAuthPlugin`](https://gitee.com/smartboot/smart-mqtt/blob/master/plugins/simple-auth-plugin/src/main/java/tech/smartboot/mqtt/auth/SimpleAuthPlugin.java) | ç®¡ç†è®¤è¯é€»è¾‘å’Œäº‹ä»¶è®¢é˜… |
| é…ç½®ç®¡ç† | [`PluginConfig`](https://gitee.com/smartboot/smart-mqtt/blob/master/plugins/simple-auth-plugin/src/main/java/tech/smartboot/mqtt/auth/PluginConfig.java) | è§£æç”¨æˆ·åå¯†ç é…ç½® |
| è´¦æˆ·å®ä½“ | `PluginConfig.Account` | å­˜å‚¨å•ä¸ªè´¦æˆ·ä¿¡æ¯ |

## é…ç½®å‚æ•°

åœ¨ `plugin.yaml` ä¸­é…ç½®ï¼š

```yaml
accounts:
  - username: admin
    password: admin123
  - username: device1
    password: device_pass
  - username: sensor_001
    password: sensor_secret
```

### å‚æ•°è¯¦è§£

| å‚æ•°å | ç±»å‹ | é»˜è®¤å€¼ | å¿…å¡« | è¯´æ˜ |
|--------|------|--------|------|------|
| `accounts` | array | [] | æ˜¯ | ç”¨æˆ·è´¦æˆ·åˆ—è¡¨ |
| `username` | string | - | æ˜¯ | ç”¨æˆ·å |
| `password` | string | - | æ˜¯ | å¯†ç ï¼ˆæ˜æ–‡å­˜å‚¨ï¼‰ |

## éƒ¨ç½²ç¤ºä¾‹

### åŸºç¡€é…ç½®

```yaml
# plugin.yaml
accounts:
  - username: admin
    password: admin123
```

### å¤šç”¨æˆ·é…ç½®

```yaml
# plugin.yaml
accounts:
  # ç®¡ç†å‘˜è´¦æˆ·
  - username: admin
    password: Admin@2024
    
  # è®¾å¤‡è´¦æˆ·
  - username: device_001
    password: dev_001_pass
  - username: device_002
    password: dev_002_pass
    
  # åº”ç”¨è´¦æˆ·
  - username: app_backend
    password: backend_secret
```

### Docker Compose éƒ¨ç½²

```yaml
version: '3.8'

services:
  mqtt-broker:
    image: smartboot/smart-mqtt:latest
    ports:
      - "1883:1883"
    volumes:
      - ./plugin.yaml:/app/plugins/simple-auth-plugin/plugin.yaml
```

## å®¢æˆ·ç«¯è¿æ¥

### MQTT.js ç¤ºä¾‹

```javascript
const mqtt = require('mqtt');

// å¸¦è®¤è¯çš„è¿æ¥
const client = mqtt.connect('mqtt://broker.example.com:1883', {
  username: 'admin',
  password: 'admin123',
  clientId: 'nodejs_client_' + Math.random().toString(16).substr(2, 8)
});

client.on('connect', () => {
  console.log('è®¤è¯æˆåŠŸï¼Œå·²è¿æ¥');
});

client.on('error', (err) => {
  console.error('è¿æ¥å¤±è´¥:', err.message);
});
```

### Python paho-mqtt ç¤ºä¾‹

```python
import paho.mqtt.client as mqtt

client = mqtt.Client(client_id="python_client_001")

# è®¾ç½®è®¤è¯ä¿¡æ¯
client.username_pw_set(username="device_001", password="dev_001_pass")

client.connect("broker.example.com", 1883, 60)
client.loop_forever()
```

### mosquitto_pub ç¤ºä¾‹

```bash
# å¸¦ç”¨æˆ·åå¯†ç å‘å¸ƒæ¶ˆæ¯
mosquitto_pub -h broker.example.com \
  -u admin \
  -P admin123 \
  -t "test/topic" \
  -m "Hello with auth"
```

### MQTT.fx é…ç½®

1. æ‰“å¼€ MQTT.fxï¼Œç‚¹å‡»è®¾ç½®å›¾æ ‡
2. åœ¨ **User Credentials** é€‰é¡¹å¡ä¸­ï¼š
   - å‹¾é€‰ **Use Username/Password**
   - Username: `admin`
   - Password: `admin123`
3. ä¿å­˜å¹¶è¿æ¥

## æ³¨æ„äº‹é¡¹

:::caution[å®‰å…¨è­¦å‘Š]
- **æ˜æ–‡å­˜å‚¨**: å¯†ç ä»¥æ˜æ–‡å½¢å¼å­˜å‚¨åœ¨é…ç½®æ–‡ä»¶ä¸­ï¼Œè¯·å¦¥å–„ä¿ç®¡é…ç½®æ–‡ä»¶
- **æƒé™æ§åˆ¶**: é…ç½®æ–‡ä»¶åº”è®¾ç½®ä¸ºåªè¯»æƒé™ï¼ˆchmod 600ï¼‰
- **ç”Ÿäº§å»ºè®®**: ç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨æ›´å®‰å…¨çš„è®¤è¯æ–¹å¼ï¼Œå¦‚æ•°æ®åº“å­˜å‚¨æˆ–é›†æˆ LDAP/Active Directory
- **ä¼ è¾“å®‰å…¨**: å»ºè®®é…åˆ `mqtts-plugin` ä½¿ç”¨ï¼Œç¡®ä¿å¯†ç åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­åŠ å¯†
:::

## ä¸å…¶ä»–è®¤è¯æ–¹å¼å¯¹æ¯”

| ç‰¹æ€§ | simple-auth-plugin | æ•°æ®åº“è®¤è¯ | LDAP/AD è®¤è¯ |
|------|-------------------|------------|--------------|
| é…ç½®å¤æ‚åº¦ | ğŸŸ¢ ç®€å• | ğŸŸ¡ ä¸­ç­‰ | ğŸ”´ å¤æ‚ |
| å®‰å…¨æ€§ | ğŸŸ¡ ä¸€èˆ¬ | ğŸŸ¢ é«˜ | ğŸŸ¢ é«˜ |
| ç”¨æˆ·ç®¡ç† | æ‰‹åŠ¨ç¼–è¾‘æ–‡ä»¶ | Web ç®¡ç†ç•Œé¢ | ç»Ÿä¸€èº«ä»½ç®¡ç† |
| åŠ¨æ€æ›´æ–° | éœ€é‡å¯ | å®æ—¶ç”Ÿæ•ˆ | å®æ—¶ç”Ÿæ•ˆ |
| é€‚ç”¨åœºæ™¯ | å¼€å‘æµ‹è¯• | ä¸­å°å‹ç”Ÿäº§ | å¤§å‹ä¼ä¸š |

## æ•…éšœæ’æŸ¥

| ç°è±¡ | å¯èƒ½åŸå›  | è§£å†³æ–¹æ¡ˆ |
|------|---------|---------|
| è¿æ¥è¢«æ‹’ç»(5) | ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯ | æ£€æŸ¥é…ç½®æ–‡ä»¶ä¸­çš„è´¦æˆ·ä¿¡æ¯ |
| æ— è®¤è¯æç¤º | æœªå®‰è£…æ’ä»¶æˆ–é…ç½®é”™è¯¯ | æ£€æŸ¥æ’ä»¶æ˜¯å¦æ­£ç¡®åŠ è½½ |
| è®¤è¯ä¸ç”Ÿæ•ˆ | å…¶ä»–è®¤è¯æ’ä»¶å†²çª | æ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–è®¤è¯æ’ä»¶å¯ç”¨ |
| é…ç½®çƒ­åŠ è½½å¤±è´¥ | æ’ä»¶ä¸æ”¯æŒçƒ­æ›´æ–° | é‡å¯ broker æœåŠ¡ |

## æ‰©å±•å¼€å‘

å¦‚éœ€å¢å¼ºå®‰å…¨æ€§ï¼Œå¯ä»¥åŸºäºæ­¤æ’ä»¶è¿›è¡ŒäºŒæ¬¡å¼€å‘ï¼š

```java
// ç¤ºä¾‹ï¼šæ·»åŠ å¯†ç å“ˆå¸ŒéªŒè¯
@Override
protected void initPlugin(BrokerContext brokerContext) throws Throwable {
    PluginConfig pluginConfig = loadPluginConfig(PluginConfig.class);
    
    // å­˜å‚¨å“ˆå¸Œåçš„å¯†ç 
    Map<String, String> accounts = pluginConfig.getAccounts().stream()
        .collect(Collectors.toMap(
            PluginConfig.Account::getUsername,
            account -> hashPassword(account.getPassword())  // ä½¿ç”¨ SHA-256 ç­‰å“ˆå¸Œ
        ));
    
    // ... è®¢é˜…äº‹ä»¶å¹¶éªŒè¯å“ˆå¸Œå¯†ç 
}

private String hashPassword(String password) {
    // å®ç°å¯†ç å“ˆå¸Œ
    return DigestUtils.sha256Hex(password + salt);
}
```

## æŠ€æœ¯æ”¯æŒ

- **ä½œè€…**: ä¸‰åˆ€ï¼ˆzhengjunweimail@163.comï¼‰
- **ä¾›åº”å•†**: smart-mqtt
- **ç‰ˆæœ¬**: ä¸ MQTT Broker ç‰ˆæœ¬ä¿æŒä¸€è‡´
